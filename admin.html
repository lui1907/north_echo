<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Admin Panel ‚Äî North Echo</title>

<link rel="stylesheet" href="style.css"/>
<script src="menu.js" defer></script>
<script src="theme.js" defer></script>
<link rel="stylesheet" href="support.css"/>

<style>
body {
  margin: 0;
  padding: 0;
  background: #0b0b0b;
  color: white;
  font-family: "Inter", sans-serif;
}

/* WRAPPER */
.admin-container {
  max-width: 1100px;
  margin: 120px auto;
  padding: 20px;
}

/* HEADER BAR */
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.admin-header h1 {
  font-size: 26px;
  margin: 0;
}

.admin-tools {
  display: flex;
  gap: 12px;
  align-items: center;
}

.admin-tools select,
.admin-tools button {
  background: #141414;
  color: white;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
}
.admin-tools button:hover {
  background: #1d1d1d;
}

/* MESSAGE BOX */
.msg-box {
  background: #111;
  border: 1px solid #222;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 18px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
  transition: .2s;
}
.msg-box:hover {
  border-color: #00aa66;
  transform: translateY(-2px);
}

.msg-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.msg-sender {
  font-weight: 600;
  font-size: 16px;
}

.msg-email {
  font-size: 13px;
  opacity: 0.7;
}

.msg-category {
  font-size: 13px;
  opacity: 0.8;
  margin-top: 3px;
}

.msg-date {
  font-size: 12px;
  opacity: 0.6;
}

.msg-text {
  margin-top: 10px;
  opacity: 0.9;
  line-height: 1.4;
  white-space: pre-wrap;
}

.msg-delete {
  background: #aa0000;
  border: none;
  color: white;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  font-size: 13px;
}
.msg-delete:hover {
  background: #cc0000;
}

/* IMAGE PREVIEW */
.msg-img {
  margin-top: 10px;
  max-width: 320px;
  max-height: 220px;
  border-radius: 8px;
  border: 1px solid #333;
  cursor: pointer;
  display: block;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  transition: 0.25s ease;
}
.msg-img:hover {
  transform: scale(1.03);
}

/* POPUP */
#confirmPopup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
}
#confirmPopup.show { display: flex; }
#confirmPopup .popup-box {
  background: #111;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 24px;
  text-align: center;
  width: 300px;
}
#confirmPopup button {
  margin: 10px 8px 0;
  padding: 8px 14px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
#confirmYes { background: #00aa66; color: white; }
#confirmNo { background: #444; color: white; }

/* IMAGE MODAL */
#imgModal {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000;
}
#imgModalContent {
  max-width:90%;
  max-height:90%;
  border-radius:10px;
  box-shadow:0 0 25px black;
}
</style>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <div class="hamburger" id="menuBtn">‚ò∞</div>
  <a href="index.html" class="logo">NORTH ECHO</a>
</header>

<!-- ADMIN CONTAINER -->
<div class="admin-container">

  <div class="admin-header">
    <h1>üì© Messages Dashboard</h1>

    <div class="admin-tools">
      <select id="filterCategory">
        <option>All</option>
        <option>Design</option>
        <option>Order</option>
        <option>Product</option>
        <option>Website</option>
        <option>Other</option>
      </select>

      <button id="sortButton">Sort: Newest First</button>
    </div>
  </div>

  <div id="adminMessages"></div>
</div>

<!-- CONFIRM POPUP -->
<div id="confirmPopup">
  <div class="popup-box">
    <p id="confirmText">Delete this message?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">Cancel</button>
  </div>
</div>

<!-- IMAGE MODAL -->
<div id="imgModal" onclick="closeImgModal()">
  <img id="imgModalContent" src="">
</div>

<!-- ADMIN JS -->
<script type="module">
// --------------------------------------------------
// üî• Supabase Setup
// --------------------------------------------------
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(
  "https://xedfviwffpsvbmyqzoof.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZGZ2aXdmZnBzdmJteXF6b29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjM0NzMsImV4cCI6MjA3ODY5OTQ3M30.SK7mEei8GTfUWWPPi4PZjxQzDl68yHsOgQMgYIHunaM"
);

// --------------------------------------------------
// üîê Admin Check
// --------------------------------------------------
const ADMINS = ["luivoss", "fisami"];
const loggedUser = localStorage.getItem("loggedInUser");
if (!loggedUser || !ADMINS.includes(loggedUser.toLowerCase())) {
  window.location.href = "index.html";
}

// --------------------------------------------------
// ‚öôÔ∏è Elements
// --------------------------------------------------
const msgContainer = document.getElementById("adminMessages");
const filterSelect = document.getElementById("filterCategory");
const sortButton = document.getElementById("sortButton");
const confirmPopup = document.getElementById("confirmPopup");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const confirmText = document.getElementById("confirmText");

let allMessages = [];
let sortOrder = "desc";
let deleteTarget = null;

// --------------------------------------------------
// üì• Load Messages
// --------------------------------------------------
async function loadMessages() {
  msgContainer.innerHTML = "<p style='opacity:.6;'>Loading...</p>";
  const { data, error } = await supabase.from("messages").select("*");
  if (error) {
    msgContainer.innerHTML = "<p>Error loading messages.</p>";
    console.error(error);
    return;
  }
  allMessages = data;
  renderMessages();
}

// --------------------------------------------------
// üßæ Render Messages
// --------------------------------------------------
function renderMessages() {
  msgContainer.innerHTML = "";
  let list = [...allMessages];

  const cat = filterSelect.value;
  if (cat !== "All") list = list.filter(m => m.category === cat);

  // üß© Tarih sƒ±ralama fix
  list.sort((a, b) => {
    const dA = new Date(a.date || a.created_at || 0);
    const dB = new Date(b.date || b.created_at || 0);
    return sortOrder === "desc" ? dB - dA : dA - dB;
  });

  if (!list.length) {
    msgContainer.innerHTML = "<p style='opacity:.6;'>No messages found.</p>";
    return;
  }

  for (const msg of list) {
    msgContainer.insertAdjacentHTML("beforeend", `
      <div class="msg-box" id="msg-${msg.id}">
        <div class="msg-top">
          <div>
            <div class="msg-sender">${msg.name || "Unknown"}</div>
            <div class="msg-email">${msg.email || ""}</div>
            <div class="msg-category">${msg.category || "No Category"}</div>
            <div class="msg-date">${msg.date || ""}</div>
          </div>
          <button class="msg-delete" data-id="${msg.id}">Delete</button>
        </div>
        <div class="msg-text">${msg.message || ""}</div>
        ${msg.file ? `<img src="${msg.file}" class="msg-img" data-url="${msg.file}">` : ""}
      </div>
    `);
  }

  bindMessageEvents();
}

// --------------------------------------------------
// üñ±Ô∏è Events
// --------------------------------------------------
function bindMessageEvents() {
  document.querySelectorAll(".msg-delete").forEach(btn => {
    btn.onclick = () => openConfirmPopup(btn.dataset.id);
  });
  document.querySelectorAll(".msg-img").forEach(img => {
    img.onclick = () => openImage(img.dataset.url);
  });
}

filterSelect.onchange = renderMessages;
sortButton.onclick = () => {
  sortOrder = sortOrder === "desc" ? "asc" : "desc";
  sortButton.textContent =
    sortOrder === "desc" ? "Sort: Newest First" : "Sort: Oldest First";
  renderMessages();
};

// --------------------------------------------------
// üß® Delete Confirmation
// --------------------------------------------------
function openConfirmPopup(id) {
  deleteTarget = id;
  confirmText.textContent = "Delete this message?";
  confirmPopup.classList.add("show");
}

confirmYes.onclick = async () => {
  if (!deleteTarget) return;
  confirmPopup.classList.remove("show");

  const { error } = await supabase.from("messages").delete().eq("id", deleteTarget);
  if (error) {
    showToast("Delete failed ‚ùå", "error");
    return;
  }

  allMessages = allMessages.filter(m => String(m.id) !== String(deleteTarget));
  renderMessages();
  showToast("Deleted permanently ‚úÖ", "success");
};

confirmNo.onclick = () => confirmPopup.classList.remove("show");

// --------------------------------------------------
// üñºÔ∏è Image Modal
// --------------------------------------------------
window.openImage = url => {
  document.getElementById("imgModalContent").src = url;
  document.getElementById("imgModal").style.display = "flex";
};
window.closeImgModal = () => {
  document.getElementById("imgModal").style.display = "none";
};

// --------------------------------------------------
// üîî Toast Notification
// --------------------------------------------------
function showToast(msg, type="info") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 50);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 2000);
}

const style = document.createElement("style");
style.innerHTML = `
.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%) scale(0.9);
  background: rgba(20,20,20,0.95);
  border: 1px solid #333;
  padding: 16px 22px;
  color: white;
  border-radius: 10px;
  opacity: 0;
  transition: all .3s;
  z-index: 999999;
  font-size: 15px;
}
.toast.show {
  opacity: 1;
  transform: translate(-50%,-50%) scale(1);
}
.toast.success { border-color:#00aa66; color:#00ff99; }
.toast.error { border-color:#aa0000; color:#ff6666; }
`;
document.head.appendChild(style);

// --------------------------------------------------
// üöÄ Start
// --------------------------------------------------
loadMessages();
</script>
</body>
</html>
