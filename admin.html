<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel ‚Äî North Echo</title>
<link rel="stylesheet" href="style.css">

<style>
body {
  background: #000;
  color: #fff;
  margin: 0;
  font-family: Arial, sans-serif;
}
.admin-wrapper {
  max-width: 1200px;
  margin: 100px auto;
  padding: 20px;
}
h1 {
  font-size: 28px;
  margin-bottom: 20px;
}
.top-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 25px;
}
select, button {
  padding: 10px;
  border-radius: 8px;
  border: none;
}
button {
  background: #00aa66;
  color: white;
  cursor: pointer;
}
button:hover {
  background: #008c54;
}
.msg-box {
  background: #0d0d0d;
  border: 1px solid #222;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
}
.msg-top {
  display: flex;
  justify-content: space-between;
}
.msg-sender {
  font-weight: bold;
}
.msg-date {
  opacity: .6;
  font-size: 13px;
  margin-top: 4px;
}
.msg-category {
  color: #00aa66;
  font-size: 14px;
  font-weight: 500;
}
.msg-text {
  margin-top: 12px;
  line-height: 1.5;
}
.msg-img {
  width: 180px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid #333;
  cursor: pointer;
  transition: 0.2s;
}
.msg-img:hover {
  transform: scale(1.03);
}
.msg-delete {
  background: #400000;
  border: none;
  color: #ff6666;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
}
.msg-delete:hover {
  background: #660000;
}

/* === üñºÔ∏è MODAL G√ñR√úNT√ú === */
#imgModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
#imgModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(0,0,0,.6);
}
#imgModalClose {
  position: absolute;
  top: 20px;
  right: 25px;
  font-size: 32px;
  color: white;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="admin-wrapper">
  <h1>üì® Support Messages</h1>

  <div class="top-bar">
    <select id="filterCategory">
      <option value="All">All Categories</option>
      <option value="Design">Design</option>
      <option value="Order">Order / Delivery</option>
      <option value="Product">Product Info</option>
      <option value="Website">Website Issue</option>
      <option value="Other">Other</option>
    </select>

    <button id="sortButton" data-order="desc">Sort: Newest First</button>
  </div>

  <div id="adminMessages"></div>
</div>

<!-- üñºÔ∏è MODAL KISMI -->
<div id="imgModal">
  <div id="imgModalClose" onclick="closeImgModal()">‚úï</div>
  <img id="imgModalContent" src="">
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://xedfviwffpsvbmyqzoof.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZGZ2aXdmZnBzdmJteXF6b29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjM0NzMsImV4cCI6MjA3ODY5OTQ3M30.SK7mEei8GTfUWWPPi4PZjxQzDl68yHsOgQMgYIHunaM";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const msgContainer = document.getElementById("adminMessages");
const filterSelect = document.getElementById("filterCategory");
const sortButton = document.getElementById("sortButton");
const imgModal = document.getElementById("imgModal");
const imgContent = document.getElementById("imgModalContent");

let allMessages = [];
let sortOrder = "desc";

// üîπ MESAJLARI Y√úKLE
async function loadMessages() {
  msgContainer.innerHTML = "<p style='opacity:.6;'>Loading...</p>";

  const { data, error } = await supabase.from("messages").select("*");

  if (error) {
    console.error("Load error:", error);
    msgContainer.innerHTML = "<p>Error loading messages.</p>";
    return;
  }

  allMessages = data || [];
  renderMessages();
}

// üîπ MESAJLARI Lƒ∞STELE
function renderMessages() {
  msgContainer.innerHTML = "";

  let list = [...allMessages];

  const category = filterSelect.value;
  if (category !== "All") list = list.filter((m) => m.category === category);

  list.sort((a, b) => {
    const dA = new Date(a.date);
    const dB = new Date(b.date);
    return sortOrder === "desc" ? dB - dA : dA - dB;
  });

  if (list.length === 0) {
    msgContainer.innerHTML = "<p style='opacity:.6;'>No messages found.</p>";
    return;
  }

  list.forEach((msg) => {
    msgContainer.innerHTML += `
      <div class="msg-box">
        <div class="msg-top">
          <div>
            <div class="msg-sender">${msg.name || "Unknown"}</div>
            <div class="msg-email" style="opacity:.7;">${msg.email || ""}</div>
            <div class="msg-category">${msg.category || "No Category"}</div>
            <div class="msg-date">${msg.date || ""}</div>
          </div>
          <button class="msg-delete" data-id="${msg.id}">Delete</button>
        </div>

        <div class="msg-text">${msg.message || ""}</div>

        ${
          msg.file
            ? `<img src="${msg.file}" class="msg-img" data-url="${msg.file}">`
            : ""
        }
      </div>
    `;
  });

  // Delete event
  document.querySelectorAll(".msg-delete").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-id");
      if (confirm("Delete this message?")) {
        const { error } = await supabase.from("messages").delete().eq("id", id);
        if (error) {
          alert("Failed to delete message.");
          console.error(error);
        } else {
          alert("Message deleted.");
          loadMessages();
        }
      }
    });
  });

  // Foto event (modal)
  document.querySelectorAll(".msg-img").forEach((img) => {
    img.addEventListener("click", () => {
      const url = img.getAttribute("data-url");
      imgContent.src = url;
      imgModal.style.display = "flex";
    });
  });
}

// üîπ Modal kapat
window.closeImgModal = function () {
  imgModal.style.display = "none";
};

// üîπ SIRALAMA
sortButton.addEventListener("click", () => {
  sortOrder = sortOrder === "desc" ? "asc" : "desc";
  sortButton.textContent =
    sortOrder === "desc" ? "Sort: Newest First" : "Sort: Oldest First";
  renderMessages();
});

filterSelect.addEventListener("change", renderMessages);

// üîπ BA≈ûLANGI√áTA Y√úKLE
loadMessages();
</script>
</body>
</html>
